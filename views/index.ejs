<%- include('partials/header') %>

<div class="container pb-5">

    <% if (typeof msg != 'undefined' && msg) { %>
        <div class="alert alert-success alert-dismissible fade show shadow-sm">
            <i class="fa-solid fa-check-circle me-2"></i><%= msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h4 class="fw-bold text-dark m-0">
                <i class="fa-solid fa-briefcase text-primary me-2"></i>İşletme Listesi
            </h4>
            <small class="text-muted"><%= isletmeler.length %> işletme sorumluluğunuzda.</small>
        </div>
        <div class="col-md-6 text-end">
            <input type="text" id="aramaKutusu" class="form-control" placeholder="İşletme ara..." onkeyup="tabloFiltrele()">
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="isletmeTablosu">
                    <thead class="table-light">
                        <tr>
                            <th>İşletme Adı</th>
                            <th>İletişim & Adres</th>
                            <th class="text-center">Öğrenci</th>
                            <th class="text-end">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (isletmeler.length === 0) { %>
                            <tr><td colspan="4" class="text-center p-5 text-muted">Henüz kayıtlı işletme yok.</td></tr>
                        <% } %>

                        <% isletmeler.forEach(isletme => { %>
                            <tr>
                                <td>
                                    <div class="fw-bold text-dark"><%= isletme.ad %></div>
                                    <div class="small text-muted"><i class="fa-solid fa-user-tie me-1"></i><%= isletme.ogrenciler[0].ustaOgretici || "Usta Yok" %></div>
                                </td>
                                
                                <td>
                                    <div class="small"><i class="fa-solid fa-phone text-success me-1"></i><%= isletme.telefon || "-" %></div>
                                    <div class="small text-muted" style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        <i class="fa-solid fa-map-pin text-danger me-1"></i><%= isletme.adres %>
                                    </div>
                                </td>

                                <td class="text-center">
                                    <span class="badge bg-primary rounded-pill px-3"><%= isletme.ogrenciSayisi %></span>
                                </td>

                                <td class="text-end">
                                    <a href="/isletme-yoklama/<%= encodeURIComponent(isletme.ad) %>" class="btn btn-sm btn-outline-primary fw-bold">
                                        <i class="fa-solid fa-clipboard-check me-1"></i>Yoklama Al
                                    </a>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function tabloFiltrele() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("aramaKutusu");
        filter = input.value.toUpperCase();
        table = document.getElementById("isletmeTablosu");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[0]; // İlk sütunda (İşletme Adı) ara
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>

<%- include('partials/footer') %>