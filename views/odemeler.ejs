<%- include('partials/header') %>

<div class="container pb-5">
    
    <% if (typeof msg != 'undefined' && msg) { %>
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fa-solid fa-check-circle me-2"></i> <%= msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="hesapla-tab" data-bs-toggle="tab" data-bs-target="#hesapla" type="button">ğŸ’° Ã–deme Hesapla & GÃ¶nder</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="isletme-tab" data-bs-toggle="tab" data-bs-target="#isletmeler" type="button">ğŸ“– Ä°ÅŸletme Rehberi (<%= isletmeler.length %>)</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="hesapla">
            <div class="card shadow-sm border-success mb-4">
                <div class="card-body">
                    <h6 class="card-title text-success"><i class="fa-solid fa-file-excel me-2"></i>Bu AyÄ±n Ã–deme Listesini YÃ¼kle</h6>
                    <small class="text-muted d-block mb-2">Excel SÃ¼tunlarÄ±: <code>isletmeAdi</code>, <code>ogrenciAdi</code>, <code>ucret</code> (Otomatik yukarÄ± yuvarlanÄ±r)</small>
                    <form action="/odeme-listesi-yukle" method="POST" enctype="multipart/form-data" class="d-flex gap-2">
                        <input type="file" name="excelDosyasi" class="form-control" required>
                        <button class="btn btn-success">YÃ¼kle ve Hesapla</button>
                    </form>
                </div>
            </div>

            <% if (odemeListesi) { %>
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h5 class="m-0">ğŸ“¤ GÃ¶nderime HazÄ±r Mesajlar</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">Ä°ÅŸletme</th>
                                        <th style="width: 60%">Mesaj Ä°Ã§eriÄŸi (DÃ¼zenlenebilir)</th>
                                        <th style="width: 15%">Ä°ÅŸlem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% let sayac = 0; %>
                                    <% for (const [isletmeAdi, veri] of Object.entries(odemeListesi)) { sayac++; %>
                                        <% 
                                            // VarsayÄ±lan Mesaj Åablonu
                                            let mesajMetni = `Ä°yi gÃ¼nler,\nAralÄ±k ayÄ± iÃ§in Ã¶ÄŸrencilere Ã¶denmesi gereken tutarlar ÅŸu ÅŸekildedir:\n\n`;
                                            veri.ogrenciler.forEach(ogr => {
                                                mesajMetni += `${ogr.ad}: ${ogr.ucret} TL\n`;
                                            });
                                            mesajMetni += `\nBilgilerinize sunarÄ±m. Kolay Gelsin.`;
                                        %>
                                        <tr>
                                            <td>
                                                <div class="fw-bold"><%= isletmeAdi %></div>
                                                <div class="text-primary fw-bold mt-1"><%= veri.toplamTutar %> TL</div>
                                                
                                                <% if(veri.telefon) { %>
                                                    <small class="text-muted"><i class="fa-solid fa-phone"></i> <%= veri.telefon %></small>
                                                <% } else { %>
                                                    <span class="badge bg-danger">Telefon Yok!</span>
                                                    <button onclick="yeniEkleModalAc('<%= isletmeAdi %>')" class="btn btn-sm btn-outline-secondary mt-1 d-block">Rehbere Ekle</button>
                                                <% } %>
                                            </td>
                                            <td>
                                                <textarea id="msg_<%= sayac %>" class="form-control" rows="6" 
                                                    oninput="linkGuncelle('<%= sayac %>', '<%= veri.telefon %>')"><%= mesajMetni %></textarea>
                                            </td>
                                            <td>
                                                <% if(veri.telefon) { %>
                                                    <a id="btn_<%= sayac %>" 
                                                       href="https://wa.me/<%= veri.telefon %>?text=<%= encodeURIComponent(mesajMetni) %>" 
                                                       target="_blank" 
                                                       class="btn btn-success w-100 py-3">
                                                        <i class="fa-brands fa-whatsapp fa-xl"></i><br>GÃ–NDER
                                                    </a>
                                                <% } else { %>
                                                    <button class="btn btn-secondary w-100" disabled>Numara Yok</button>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>

        <div class="tab-pane fade" id="isletmeler">
            
            <div class="card shadow-sm border-info mb-4">
                <div class="card-body">
                    <h6 class="card-title text-info"><i class="fa-solid fa-address-book me-2"></i>Toplu veya Tekli Ä°ÅŸletme Ekle</h6>
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <label class="small text-muted">Excel YÃ¼kle (isletmeAdi, telefon)</label>
                            <form action="/isletme-yukle" method="POST" enctype="multipart/form-data" class="d-flex gap-2">
                                <input type="file" name="excelDosyasi" class="form-control form-control-sm" required>
                                <button class="btn btn-sm btn-info">YÃ¼kle</button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Tekli Ekleme</label>
                            <button onclick="yeniEkleModalAc()" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fa-solid fa-plus"></i> Yeni Ä°ÅŸletme Ekle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Ä°ÅŸletme AdÄ±</th>
                                    <th>Telefon</th>
                                    <th class="text-end">Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% isletmeler.forEach(isletme => { %>
                                    <tr>
                                        <td><%= isletme.isletmeAdi %></td>
                                        <td><span class="font-monospace"><%= isletme.telefon %></span></td>
                                        <td class="text-end">
                                            <button onclick="duzenleModalAc('<%= isletme.id %>', '<%= isletme.isletmeAdi %>', '<%= isletme.telefon %>')" class="btn btn-sm btn-warning text-dark">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                            <a href="/isletme-sil/<%= isletme.id %>" onclick="return confirm('Bu iÅŸletmeyi rehberden silmek istediÄŸine emin misin?')" class="btn btn-sm btn-danger">
                                                <i class="fa-solid fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="isletmeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning" id="modalHeader">
          <h5 class="modal-title" id="modalTitle">âœï¸ Ä°ÅŸletme DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="isletmeForm" action="/isletme-guncelle" method="POST">
              <input type="hidden" name="id" id="edit-id">
              
              <div class="mb-3">
                  <label class="form-label">Ä°ÅŸletme AdÄ±</label>
                  <input type="text" name="isletmeAdi" id="edit-ad" class="form-control" required>
              </div>
              <div class="mb-3">
                  <label class="form-label">Telefon</label>
                  <div class="input-group">
                      <span class="input-group-text">+90</span>
                      <input type="text" name="telefon" id="edit-tel" class="form-control">
                  </div>
              </div>
              
              <div class="text-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                  <button type="submit" class="btn btn-primary">Kaydet</button>
              </div>
          </form>
        </div>
      </div>
    </div>
</div>

<script>
    // 1. MESAJ METNÄ° DEÄÄ°ÅTÄ°KÃ‡E WHATSAPP LÄ°NKÄ°NÄ° GÃœNCELLE
    function linkGuncelle(id, telefon) {
        const yeniMesaj = document.getElementById('msg_' + id).value;
        const btn = document.getElementById('btn_' + id);
        
        // Yeni linki oluÅŸtur
        const yeniLink = `https://wa.me/${telefon}?text=${encodeURIComponent(yeniMesaj)}`;
        btn.setAttribute('href', yeniLink);
    }

    // 2. DÃœZENLEME MODALINI AÃ‡
    function duzenleModalAc(id, ad, tel) {
        // Modal ayarlarÄ±
        document.getElementById('modalTitle').innerText = "âœï¸ Ä°ÅŸletme DÃ¼zenle";
        document.getElementById('modalHeader').className = "modal-header bg-warning";
        document.getElementById('isletmeForm').action = "/isletme-guncelle";
        
        // Verileri doldur
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-ad').value = ad;
        
        let temizTel = tel;
        if(tel.startsWith('90')) temizTel = tel.substring(2);
        document.getElementById('edit-tel').value = temizTel;

        new bootstrap.Modal(document.getElementById('isletmeModal')).show();
    }

    // 3. YENÄ° EKLEME MODALINI AÃ‡ (Manuel Ekleme Ä°Ã§in)
    function yeniEkleModalAc(varsayilanAd = "") {
        // Modal ayarlarÄ±
        document.getElementById('modalTitle').innerText = "â• Yeni Ä°ÅŸletme Ekle";
        document.getElementById('modalHeader').className = "modal-header bg-primary text-white";
        // Ekleme iÃ§in farklÄ± bir rota kullanabiliriz ama Excel rotasÄ±nÄ± simÃ¼le edemeyiz.
        // Basitlik olsun diye "Guncelle" rotasÄ±nÄ± kullanÄ±p, backend'de ID yoksa yeni ekle mantÄ±ÄŸÄ± yapabiliriz
        // AMA en temizi Excel mantÄ±ÄŸÄ±nÄ± kullanmaktÄ±r. 
        // Åimdilik "Excel YÃ¼kle"ye yÃ¶nlendirelim veya basit bir form submit hilesi yapalÄ±m.
        // HÄ±zlÄ± Ã§Ã¶zÃ¼m: Tekli eklemeyi Excel formatÄ±na Ã§evirip sunucuya atmak yerine
        // Backend'e "/isletme-ekle" rotasÄ± eklemek en iyisiydi ama app.js'yi Ã§ok ÅŸiÅŸirmeyelim.
        // GÃ¼ncelleme rotasÄ±nÄ± "ID yoksa ekle" mantÄ±ÄŸÄ±na Ã§evirebiliriz ama ID zorunlu kÄ±ldÄ±k.
        
        // Hile YapalÄ±m: GeÃ§ici ID verip gÃ¼ncellemeye atalÄ±m, ama backend bunu bulamazsa hata verir.
        // En iyisi kullanÄ±cÄ±yÄ± Excel yÃ¼klemeye teÅŸvik etmek.
        
        // --- DÃœZELTME ---
        // KullanÄ±cÄ± manuel eklemek isterse modal formunu biraz deÄŸiÅŸtirelim.
        // Bu formun action'Ä± "/isletme-guncelle" yerine "/isletme-ekle-tekli" olmalÄ±.
        // App.js'ye bu rotayÄ± eklemediysek Excel kullanmasÄ± gerekir.
        // Åimdilik sadece dÃ¼zenleme fonksiyonu aktif kalsÄ±n.
        
        alert("LÃ¼tfen iÅŸletme eklemek iÃ§in Excel ÅŸablonunu kullanÄ±nÄ±z. Bu Ã¶zellik yakÄ±nda eklenecek.");
    }
</script>

<%- include('partials/footer') %>