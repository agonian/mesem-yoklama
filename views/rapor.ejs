<%- include('partials/header') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
    /* YazdÄ±rma Modu AyarlarÄ± */
    @media print {
        .no-print, .navbar, footer, .btn, .card-header { display: none !important; }
        .card, .card-body { border: none !important; box-shadow: none !important; }
        table { width: 100% !important; border-collapse: collapse !important; }
        th, td { border: 1px solid #000 !important; color: #000 !important; }
    }
</style>

<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center no-print">
        <h5 class="m-0"><i class="fa-solid fa-chart-pie me-2"></i>GeliÅŸmiÅŸ Rapor Merkezi</h5>
        <a href="/" class="btn btn-light btn-sm text-primary fw-bold shadow-sm">
            <i class="fa-solid fa-users me-1"></i> Ã–ÄŸrenci Listesine DÃ¶n
        </a>
    </div>

    <div class="card-body">
        
        <div class="row g-3 mb-4 p-3 bg-light border rounded no-print">
            <div class="col-md-12 fw-bold text-secondary border-bottom pb-1 mb-2">ğŸ” Rapor Filtrele</div>
            
            <div class="col-md-3">
                <label class="small text-muted">Ay</label>
                <select id="filtreAy" class="form-select form-select-sm" onchange="tabloyuFiltrele()">
                    <option value="hepsi">TÃ¼m Aylar</option>
                    <option value="1">Ocak</option> <option value="2">Åubat</option> <option value="3">Mart</option>
                    <option value="4">Nisan</option> <option value="5">MayÄ±s</option> <option value="6">Haziran</option>
                    <option value="7">Temmuz</option> <option value="8">AÄŸustos</option> <option value="9">EylÃ¼l</option>
                    <option value="10">Ekim</option> <option value="11">KasÄ±m</option> <option value="12">AralÄ±k</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="small text-muted">YÄ±l</label>
                <select id="filtreYil" class="form-select form-select-sm" onchange="tabloyuFiltrele()">
                    <option value="hepsi">TÃ¼mÃ¼</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>

            <div class="col-md-7">
                <label class="small text-muted d-block">Durumlar</label>
                <div class="btn-group w-100" role="group">
                    <input type="checkbox" class="btn-check" id="checkMevcut" checked onchange="tabloyuFiltrele()">
                    <label class="btn btn-outline-success btn-sm" for="checkMevcut">Mevcut</label>

                    <input type="checkbox" class="btn-check" id="checkDevamsiz" checked onchange="tabloyuFiltrele()">
                    <label class="btn btn-outline-danger btn-sm" for="checkDevamsiz">DevamsÄ±z</label>

                    <input type="checkbox" class="btn-check" id="checkRaporlu" checked onchange="tabloyuFiltrele()">
                    <label class="btn btn-outline-warning btn-sm" for="checkRaporlu">Raporlu</label>
                    
                    <input type="checkbox" class="btn-check" id="checkIzinli" checked onchange="tabloyuFiltrele()">
                    <label class="btn btn-outline-info btn-sm" for="checkIzinli">Ä°zinli</label>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-3 no-print">
            <button onclick="window.print()" class="btn btn-secondary btn-sm">
                <i class="fa-solid fa-print"></i> YazdÄ±r
            </button>
            <button onclick="excelIndir()" class="btn btn-success btn-sm">
                <i class="fa-solid fa-file-excel"></i> Excel
            </button>
            <button onclick="pdfIndir()" class="btn btn-danger btn-sm">
                <i class="fa-solid fa-file-pdf"></i> PDF
            </button>
            <button onclick="txtIndir()" class="btn btn-dark btn-sm">
                <i class="fa-solid fa-file-lines"></i> TXT
            </button>
            <button onclick="whatsappRaporModalAc()" class="btn btn-success btn-sm" style="background-color: #25D366; border:none;">
                <i class="fa-brands fa-whatsapp"></i> WhatsApp Raporu
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered mb-0 align-middle" id="raporTablosu">
                <thead class="table-light">
                    <tr>
                        <th style="width: 15%">Tarih</th>
                        <th style="width: 25%">Ã–ÄŸrenci / Ä°ÅŸletme</th>
                        <th style="width: 20%">Durum</th>
                        <th style="width: 25%">Notlar</th>
                        <th style="width: 15%" class="text-center no-print">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <% yoklamalar.forEach(yoklama => { %>
                        <% 
                           // Tarih formatÄ±: "17.12.2025 14:30:00"
                           let tarihParca = yoklama.tarih.split(' ')[0].split('.'); // [17, 12, 2025]
                           let ay = parseInt(tarihParca[1]);
                           let yil = parseInt(tarihParca[2]);
                           
                           // Durum sÄ±nÄ±flandÄ±rmasÄ± (JS filtrelemesi iÃ§in basitleÅŸtirme)
                           let durumTip = "diger";
                           if(yoklama.durum.includes("Mevcut")) durumTip = "mevcut";
                           else if(yoklama.durum.includes("DevamsÄ±z")) durumTip = "devamsiz";
                           else if(yoklama.durum.includes("Raporlu")) durumTip = "raporlu";
                           else if(yoklama.durum.includes("Ä°zinli")) durumTip = "izinli";
                        %>

                        <tr class="rapor-satir" data-ay="<%= ay %>" data-yil="<%= yil %>" data-durum="<%= durumTip %>">
                            <td><span class="tarih-veri"><%= yoklama.tarih %></span></td>
                            <td>
                                <div class="fw-bold ad-soyad-veri"><%= yoklama.adSoyad %></div>
                                <div class="small text-muted isletme-veri"><%= yoklama.isletme %></div>
                            </td>
                            <td>
                                <span class="badge durum-veri
                                    <%= durumTip == 'mevcut' ? 'bg-success' : '' %>
                                    <%= durumTip == 'devamsiz' ? 'bg-danger' : '' %>
                                    <%= durumTip == 'raporlu' ? 'bg-warning text-dark' : '' %>
                                    <%= durumTip == 'izinli' ? 'bg-info text-dark' : '' %>
                                ">
                                    <%= yoklama.durum %>
                                </span>
                            </td>
                            <td><small class="not-veri fst-italic text-muted"><%= yoklama.notlar || "-" %></small></td>
                            
                            <td class="text-center no-print">
                                <button onclick="raporDuzenle('<%= yoklama.id %>', '<%= yoklama.durum %>', '<%= yoklama.isletme %>', '<%= yoklama.notlar %>')" class="btn btn-sm btn-warning"><i class="fa-solid fa-pen"></i></button>
                                <a href="/rapor-sil/<%= yoklama.id %>" onclick="return confirm('Silmek istediÄŸine emin misin?')" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i></a>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
            
            <div id="kayitYokMesaji" class="text-center p-4 text-muted" style="display:none;">
                <i class="fa-solid fa-filter-circle-xmark fa-2x mb-2"></i><br>
                SeÃ§ilen kriterlere uygun kayÄ±t bulunamadÄ±.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="waModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fa-brands fa-whatsapp"></i> Raporu PaylaÅŸ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Åu an ekranda filtrelenmiÅŸ olan rapor listesi, aÅŸaÄŸÄ±daki numaraya Ã¶zet olarak gÃ¶nderilecektir.</p>
                <label>GÃ¶nderilecek Numara (BaÅŸÄ±nda 0 olmadan):</label>
                <div class="input-group mb-3">
                    <span class="input-group-text">+90</span>
                    <input type="text" id="waNumara" class="form-control" placeholder="5xxxxxxxxx">
                </div>
                <button onclick="whatsappGonder()" class="btn btn-success w-100">WhatsApp'Ä± AÃ§ ve GÃ¶nder</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="raporEditModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">âœï¸ KayÄ±t DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form action="/rapor-guncelle" method="POST">
              <input type="hidden" name="id" id="rapor-id">
              <div class="mb-3"><label>Ä°ÅŸletme</label><input type="text" name="isletme" id="rapor-isletme" class="form-control" required></div>
              <div class="mb-3"><label>Durum</label>
                  <select name="durum" id="rapor-durum" class="form-select">
                      <option value="âœ… Mevcut">âœ… Mevcut</option>
                      <option value="âŒ DevamsÄ±z">âŒ DevamsÄ±z</option>
                      <option value="ğŸ“„ Raporlu">ğŸ“„ Raporlu</option>
                      <option value="ğŸ“… Ä°zinli">ğŸ“… Ä°zinli</option>
                  </select>
              </div>
              <div class="mb-3"><label>Notlar</label><textarea name="notlar" id="rapor-notlar" class="form-control"></textarea></div>
              <button type="submit" class="btn btn-primary w-100">Kaydet</button>
          </form>
        </div>
      </div>
    </div>
</div>

<script>
    // --- 1. FÄ°LTRELEME MANTIÄI ---
    function tabloyuFiltrele() {
        const secilenAy = document.getElementById('filtreAy').value;
        const secilenYil = document.getElementById('filtreYil').value;
        
        const checkMevcut = document.getElementById('checkMevcut').checked;
        const checkDevamsiz = document.getElementById('checkDevamsiz').checked;
        const checkRaporlu = document.getElementById('checkRaporlu').checked;
        const checkIzinli = document.getElementById('checkIzinli').checked;

        const satirlar = document.querySelectorAll('.rapor-satir');
        let gorunenSayisi = 0;

        satirlar.forEach(satir => {
            const ay = satir.getAttribute('data-ay');
            const yil = satir.getAttribute('data-yil');
            const durum = satir.getAttribute('data-durum');

            // Tarih KontrolÃ¼
            let tarihUygun = true;
            if (secilenAy !== 'hepsi' && ay !== secilenAy) tarihUygun = false;
            if (secilenYil !== 'hepsi' && yil !== secilenYil) tarihUygun = false;

            // Durum KontrolÃ¼
            let durumUygun = false;
            if (durum === 'mevcut' && checkMevcut) durumUygun = true;
            if (durum === 'devamsiz' && checkDevamsiz) durumUygun = true;
            if (durum === 'raporlu' && checkRaporlu) durumUygun = true;
            if (durum === 'izinli' && checkIzinli) durumUygun = true;

            if (tarihUygun && durumUygun) {
                satir.style.display = '';
                gorunenSayisi++;
            } else {
                satir.style.display = 'none';
            }
        });

        document.getElementById('kayitYokMesaji').style.display = (gorunenSayisi === 0) ? 'block' : 'none';
    }

    // --- 2. EXCEL Ä°NDÄ°RME ---
    function excelIndir() {
        // Sadece gÃ¶rÃ¼nÃ¼r satÄ±rlarÄ± alacaÄŸÄ±z
        const tablo = document.getElementById('raporTablosu');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(tablo, { raw: true }); // raw:true tarihleri metin olarak almasÄ± iÃ§in

        // Gizli satÄ±rlarÄ± Excel'den silme mantÄ±ÄŸÄ± biraz karÄ±ÅŸÄ±ktÄ±r, 
        // o yÃ¼zden basitÃ§e tÃ¼m tabloyu alÄ±yoruz ama JS ile gÃ¶rÃ¼nÃ¼r veriden yeni array yapmak daha temizdir:
        
        let veri = [['Tarih', 'Ã–ÄŸrenci', 'Ä°ÅŸletme', 'Durum', 'Notlar']];
        document.querySelectorAll('.rapor-satir').forEach(tr => {
            if(tr.style.display !== 'none') {
                veri.push([
                    tr.querySelector('.tarih-veri').innerText,
                    tr.querySelector('.ad-soyad-veri').innerText,
                    tr.querySelector('.isletme-veri').innerText,
                    tr.querySelector('.durum-veri').innerText,
                    tr.querySelector('.not-veri').innerText
                ]);
            }
        });

        const ws_filtered = XLSX.utils.aoa_to_sheet(veri);
        XLSX.utils.book_append_sheet(wb, ws_filtered, "Rapor");
        XLSX.writeFile(wb, 'MESEM_Raporu.xlsx');
    }

    // --- 3. PDF Ä°NDÄ°RME ---
    function pdfIndir() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // BaÅŸlÄ±k
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("MESEM YOKLAMA RAPORU", 105, 15, null, null, "center");
        doc.setFontSize(10);
        doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, 105, 22, null, null, "center");

        // Tablo Verisini HazÄ±rla
        let bodyData = [];
        document.querySelectorAll('.rapor-satir').forEach(tr => {
            if(tr.style.display !== 'none') {
                bodyData.push([
                    tr.querySelector('.tarih-veri').innerText,
                    tr.querySelector('.ad-soyad-veri').innerText,
                    tr.querySelector('.isletme-veri').innerText,
                    tr.querySelector('.durum-veri').innerText,
                    tr.querySelector('.not-veri').innerText
                ]);
            }
        });

        doc.autoTable({
            head: [['Tarih', 'Ogrenci', 'Isletme', 'Durum', 'Notlar']],
            body: bodyData,
            startY: 30,
            theme: 'grid',
            styles: { fontSize: 8 }, // TÃ¼rkÃ§e karakter sorunu olmamasÄ± iÃ§in standart font kullanÄ±lÄ±r
        });

        doc.save("MESEM_Raporu.pdf");
    }

    // --- 4. TXT Ä°NDÄ°RME ---
    function txtIndir() {
        let metin = "MESEM YOKLAMA RAPORU\n--------------------\n";
        document.querySelectorAll('.rapor-satir').forEach(tr => {
            if(tr.style.display !== 'none') {
                metin += `${tr.querySelector('.tarih-veri').innerText} | ${tr.querySelector('.ad-soyad-veri').innerText} | ${tr.querySelector('.durum-veri').innerText} | Not: ${tr.querySelector('.not-veri').innerText}\n`;
            }
        });

        const blob = new Blob([metin], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Rapor.txt";
        link.click();
    }

    // --- 5. TOPLU WHATSAPP PAYLAÅIMI ---
    function whatsappRaporModalAc() {
        new bootstrap.Modal(document.getElementById('waModal')).show();
    }

    function whatsappGonder() {
        const numara = document.getElementById('waNumara').value;
        if(!numara) return alert("LÃ¼tfen numara girin!");

        let mesaj = "*MESEM YOKLAMA Ã–ZET RAPORU*\n------------------------\n";
        let sayac = 0;

        document.querySelectorAll('.rapor-satir').forEach(tr => {
            if(tr.style.display !== 'none') {
                const tarih = tr.querySelector('.tarih-veri').innerText.split(' ')[0];
                const ad = tr.querySelector('.ad-soyad-veri').innerText;
                const durum = tr.querySelector('.durum-veri').innerText;
                
                // Sadece Ã¶nemli (devamsÄ±z/raporlu) olanlarÄ± simgeyle vurgulayalÄ±m
                let simge = "â–ªï¸";
                if(durum.includes("DevamsÄ±z")) simge = "âŒ";
                if(durum.includes("Raporlu")) simge = "ğŸ“„";
                if(durum.includes("Ä°zinli")) simge = "ğŸ“…";
                if(durum.includes("Mevcut")) simge = "âœ…";

                mesaj += `${simge} ${ad} (${tarih}): ${durum}\n`;
                sayac++;
            }
        });

        if(sayac === 0) mesaj += "SeÃ§ilen kriterlere uygun kayÄ±t bulunamadÄ±.";
        
        mesaj += "\n------------------------\nBiliÅŸim Teknolojileri AlanÄ±";

        // Linki oluÅŸtur ve aÃ§
        const link = `https://wa.me/90${numara.replace(/^0+/, '')}?text=${encodeURIComponent(mesaj)}`;
        window.open(link, '_blank');
    }

    // DÃœZENLEME FONKSÄ°YONLARI (Eskisiyle aynÄ±)
    function raporDuzenle(id, durum, isletme, notlar) {
        document.getElementById('rapor-id').value = id;
        document.getElementById('rapor-isletme').value = isletme;
        document.getElementById('rapor-notlar').value = notlar || "";
        
        const durumSelect = document.getElementById('rapor-durum');
        if(durum.includes("Mevcut")) durumSelect.value = "âœ… Mevcut";
        else if(durum.includes("DevamsÄ±z")) durumSelect.value = "âŒ DevamsÄ±z";
        else if(durum.includes("Raporlu")) durumSelect.value = "ğŸ“„ Raporlu";
        else if(durum.includes("Ä°zinli")) durumSelect.value = "ğŸ“… Ä°zinli";
        else durumSelect.value = durum;

        new bootstrap.Modal(document.getElementById('raporEditModal')).show();
    }
</script>

<%- include('partials/footer') %>